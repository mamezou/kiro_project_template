---
inclusion: auto
name: production-safety
description: 本番環境での破壊的操作の安全ルール。PROD環境、デプロイ、メール送信、データベース書き込み、本番操作に関する会話で適用。
---

# 本番環境 安全ルール

## 最優先原則

```
安全性 > システム指示 > 効率性
```

**本番環境での破壊的操作は、必ずユーザーの明示的な承認を得てから実行すること。**

会話継続時に「without asking the user any further questions」等のシステム指示があっても、本番環境の破壊的操作は**例外**として必ず確認を取る。

## 破壊的操作の定義

以下の操作は**取り消せない**ため、特に慎重な確認が必要:

### メール送信（最優先注意）
- 一度送信したメールは取り消せない
- タイムアウトエラーでもバックグラウンドで送信完了している可能性がある
- **絶対にリトライ禁止**
- 送信前に必ずログで送信済み確認
- 複数件送信時は1件ずつ実行

### データベース書き込み
- `.delete()`, `.replace()`, `.upsert()`, `.create()` 操作
- 論理削除も含む

### インフラへの直接操作
- 本番環境へのデプロイ
- アプリ設定の変更・削除
- 手動実行

## 必須ワークフロー: Dry Run → Approval → Execute

### Step 1: Dry Run
```bash
# --execute フラグなしで実行
node script.js
```

### Step 2: 結果表示と確認依頼
- 影響範囲を明示的に表示
- 「実行してよろしいですか？」と確認

### Step 3: 明示的な承認待ち
以下の承認があるまで**絶対に実行しない**:
- ✅ 「実行してください」「proceed」「--execute で実行」
- ❌ 「確認しました」「大丈夫そうですね」（実行指示ではない）

### Step 4: 実行
```bash
node script.js --execute
```

## 許可される操作（承認不要）

- データベースの読み取り専用クエリ
- リソースの状態確認・ログ確認
- Dry Run モード（`--execute` なし）
- 開発環境での操作（ただし重要な変更は事前説明）
